---
/**
 * Hero search form: Service (with datalist autocomplete) + ZIP (with geolocation).
 * Vanilla JS only: geolocation → reverse geocode for ZIP; submit → redirect to /services/?q=&zip=
 */
const serviceOptions = [
  'TV Mounting',
  'Plumbing',
  'Electrical',
  'House Cleaning',
  'Handyman',
  'Security Cameras',
  'Wi-Fi Setup',
];
---

<div class="hero-search-form mx-auto w-full max-w-md">
  <form
    id="hero-search-form"
    class="rounded-2xl bg-white p-5 shadow-xl sm:p-6"
    action="/services/"
    method="get"
    role="search"
    aria-label="Find a pro by service and location"
  >
    <div class="space-y-4">
      <!-- Service input + datalist -->
      <div>
        <label for="hero-search-service" class="sr-only">What type of service do you need?</label>
        <input
          id="hero-search-service"
          type="text"
          name="q"
          list="hero-services-list"
          placeholder="What type of service do you need?"
          autocomplete="off"
          class="w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-3.5 text-slate-900 placeholder-slate-500 transition focus:border-[#f97415] focus:bg-white focus:outline-none focus:ring-2 focus:ring-[#f97415]/20"
        />
        <p id="hero-error-service" class="hero-form-error mt-1 text-sm text-red-600" role="alert" aria-live="polite"></p>
        <datalist id="hero-services-list">
          {serviceOptions.map((option) => (
            <option value={option} />
          ))}
        </datalist>
      </div>

      <!-- ZIP input + location button -->
      <div class="relative">
        <label for="hero-search-zip" class="sr-only">Enter Service Zip Code</label>
        <input
          id="hero-search-zip"
          type="text"
          name="zip"
          placeholder="Enter Service Zip Code"
          inputmode="numeric"
          pattern="[0-9]{5}"
          maxlength="5"
          autocomplete="postal-code"
          class="w-full rounded-xl border border-slate-200 bg-slate-50/50 py-3.5 pl-4 pr-12 text-slate-900 placeholder-slate-500 transition focus:border-[#f97415] focus:bg-white focus:outline-none focus:ring-2 focus:ring-[#f97415]/20"
        />
        <p id="hero-error-zip" class="hero-form-error mt-1 text-sm text-red-600" role="alert" aria-live="polite"></p>
        <button
          type="button"
          id="hero-search-location-btn"
          class="absolute right-2 top-1/2 flex h-9 w-9 -translate-y-1/2 items-center justify-center rounded-lg text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-[#f97415]/50 focus:ring-inset disabled:opacity-50"
          aria-label="Use my location to fill ZIP code"
          title="Use my location"
        >
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
          </svg>
        </button>
      </div>

      <button
        type="submit"
        class="w-full rounded-xl bg-[#0073e6] py-3.5 text-base font-semibold text-white shadow-sm transition hover:bg-[#0062cc] focus:outline-none focus:ring-2 focus:ring-[#0073e6] focus:ring-offset-2"
      >
        Get a Free Quote
      </button>
    </div>
  </form>
</div>

<script>
  (function () {
    const form = document.getElementById('hero-search-form');
    const zipInput = document.getElementById('hero-search-zip');
    const locationBtn = document.getElementById('hero-search-location-btn');

    if (!form || !zipInput || !locationBtn) return;

    // Location button: geolocation → reverse geocode → fill ZIP
    locationBtn.addEventListener('click', function () {
      if (!navigator.geolocation) {
        zipInput.setCustomValidity('Location is not supported by your browser.');
        zipInput.reportValidity();
        return;
      }

      locationBtn.setAttribute('disabled', '');
      locationBtn.setAttribute('aria-busy', 'true');

      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const url = 'https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=' + encodeURIComponent(lat) + '&longitude=' + encodeURIComponent(lng) + '&localityLanguage=en';

          fetch(url)
            .then(function (res) { return res.json(); })
            .then(function (data) {
              const zip = data.postcode || (data.localityInfo && data.localityInfo.administrative && data.localityInfo.administrative[0] && data.localityInfo.administrative[0].postcode);
              if (zip) {
                zipInput.value = String(zip).slice(0, 5);
                zipInput.setCustomValidity('');
              }
            })
            .catch(function () {
              zipInput.setCustomValidity('Could not get address from location.');
              zipInput.reportValidity();
            })
            .finally(function () {
              locationBtn.removeAttribute('disabled');
              locationBtn.removeAttribute('aria-busy');
            });
        },
        function () {
          zipInput.setCustomValidity('Location was denied or unavailable.');
          zipInput.reportValidity();
          locationBtn.removeAttribute('disabled');
          locationBtn.removeAttribute('aria-busy');
        }
      );
    });

    // Restrict ZIP to digits only
    zipInput.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, 5);
    });

    // Form submit: validate service + zip; show errors or open quote modal
    const serviceInput = form.querySelector('[name="q"]');
    const errorService = document.getElementById('hero-error-service');
    const errorZip = document.getElementById('hero-error-zip');

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const service = (serviceInput && serviceInput.value) ? serviceInput.value.trim() : '';
      const zip = (zipInput && zipInput.value) ? zipInput.value.trim() : '';

      // Clear previous errors
      if (errorService) {
        errorService.textContent = '';
        errorService.classList.remove('hero-form-error-visible');
      }
      if (errorZip) {
        errorZip.textContent = '';
        errorZip.classList.remove('hero-form-error-visible');
      }

      let hasError = false;
      if (!service) {
        hasError = true;
        if (errorService) {
          errorService.textContent = 'Please select or enter a service type.';
          errorService.classList.add('hero-form-error-visible');
        }
      }
      if (!zip) {
        hasError = true;
        if (errorZip) {
          errorZip.textContent = 'Please enter your ZIP code.';
          errorZip.classList.add('hero-form-error-visible');
        }
      }

      if (hasError) return;

      const hiddenService = document.getElementById('quote-hidden-service');
      const hiddenZip = document.getElementById('quote-hidden-zip');
      const quoteModal = document.getElementById('quote-modal');
      if (hiddenService) hiddenService.value = service;
      if (hiddenZip) hiddenZip.value = zip;
      if (quoteModal && typeof quoteModal.showModal === 'function') {
        quoteModal.showModal();
        document.body.style.overflow = 'hidden';
      }
    });
  })();
</script>

<style>
  .hero-form-error {
    opacity: 0;
    min-height: 0;
    transition: opacity 0.3s ease-out;
  }
  .hero-form-error.hero-form-error-visible {
    opacity: 1;
  }
</style>
