---
/**
 * Global Quote and Booking modals using native <dialog>.
 * Migrated from legacy React BookingModal.tsx – 4-step quote flow with semantic HTML and vanilla JS.
 * Trigger: any element with data-open-quote or data-open-booking.
 */
const services = [
  { value: "house-cleaning", label: "House Cleaning" },
  { value: "tv-mounting", label: "TV Mounting" },
  { value: "smart-home", label: "Smart Home Installation" },
  { value: "plumbing", label: "Plumbing" },
  { value: "electrical", label: "Electrical" },
  { value: "handyman", label: "Handyman Services" },
  { value: "bathroom-remodeling", label: "Bathroom Remodeling" },
  { value: "pressure-washing", label: "Pressure Washing" },
  { value: "junk-removal", label: "Junk Removal" },
  { value: "wifi-network", label: "WiFi & Network Setup" },
  { value: "home-theater", label: "Home Theater" },
  { value: "security", label: "Security Cameras" },
  { value: "computer-repair", label: "Computer Repair" },
  { value: "hvac", label: "HVAC" },
  { value: "website-design", label: "Website Design" },
  { value: "other", label: "Other" },
];

// Booking modal: category → services (ScheduleServiceDialog parity)
const bookingCategories = [
  { category: "TV Mounting & Home Theater", services: ["TV Wall Mounting - Standard (up to 55\")", "TV Wall Mounting - Large (56\" - 75\")", "TV Wall Mounting - Extra Large (76\"+)", "Full Home Theater Setup", "Soundbar Installation", "Surround Sound System", "Projector Installation", "Cable Concealment"] },
  { category: "Computer Support", services: ["Computer Repair & Diagnostics", "Virus & Malware Removal", "Data Backup & Recovery", "Software Installation & Updates", "Hardware Upgrade (RAM/SSD)", "Operating System Reinstall", "Printer Setup & Troubleshooting", "Performance Optimization"] },
  { category: "Internet & Wi-Fi", services: ["Router Setup & Configuration", "Wi-Fi Network Optimization", "Dead Zone Elimination", "Mesh Network Installation", "Network Security Setup", "Ethernet Wiring Installation", "Smart Home Network Setup", "Business Network Configuration"] },
  { category: "Security Cameras", services: ["Indoor Camera Installation", "Outdoor Camera Installation", "Video Doorbell Setup", "Multi-Camera System", "DVR/NVR Configuration", "Smart Lock Installation", "Motion Sensor Setup", "Security System Integration"] },
  { category: "Other Services", services: ["Smart Thermostat Installation", "Printer Setup & Troubleshooting", "Smart Home Integration", "General Handyman Services", "Custom Tech Projects"] },
];
---

<style is:global>
  .modal-dialog {
    margin: auto;
    inset: 0;
    width: fit-content;
    max-width: calc(100vw - 2rem);
    height: fit-content;
    max-height: 90vh;
    position: fixed;
  }
</style>

<!-- Quote Modal (4-step: Service → ZIP → Details → Contact) -->
<dialog id="quote-modal" class="modal-dialog rounded-2xl border-0 bg-white p-0 shadow-2xl backdrop:bg-black/40 backdrop:backdrop-blur-sm sm:max-w-[532px] overflow-hidden" aria-labelledby="quote-modal-title" aria-describedby="quote-modal-desc">
  <div class="relative max-h-[90vh] w-full overflow-y-auto">
    <button type="button" class="modal-close absolute top-4 right-4 z-10 flex h-9 w-9 items-center justify-center rounded-full text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-[#0073e6]" aria-label="Close quote modal" data-close-dialog="quote-modal">
      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <form id="quote-form" method="post" action="https://formspree.io/f/YOUR_ENDPOINT_HERE">
      <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" class="absolute -left-[9999px]" aria-hidden="true" />
      <input type="hidden" id="quote-hidden-service" name="service" value="" />
      <input type="hidden" id="quote-hidden-zip" name="zip" value="" />
      <input type="hidden" id="quote-hidden-urgency" name="urgency" value="" />

      <!-- "Finding pros..." overlay (React parity: brief delay before step 4) -->
      <div id="quote-finding-pros" class="hidden absolute inset-0 z-20 flex items-center justify-center rounded-2xl bg-white/95 p-8">
        <div class="text-center">
          <div class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-[#0073e6]/10 text-[#0073e6] mb-4">
            <svg id="quote-finding-spinner" class="h-6 w-6 animate-spin" fill="none" viewBox="0 0 24 24" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          </div>
          <p class="text-lg font-medium text-slate-900">Finding pros near you...</p>
        </div>
      </div>

      <div class="p-6 pr-14 relative">
        <!-- Step 1: Service selection (free-text with suggestions) -->
        <div id="quote-step-1" class="quote-step space-y-6">
          <div class="text-center">
            <h2 id="quote-modal-title" class="font-display text-2xl font-bold text-slate-900 mb-2">What do you need help with?</h2>
            <p id="quote-modal-desc" class="text-slate-500">Select a service to get a no obligation quote</p>
          </div>
          <div class="relative w-full">
            <label for="quote-service-input" class="block text-sm font-medium text-slate-700 mb-0.5">What type of service do you want?</label>
            <input type="text" id="quote-service-input" name="service_input" autocomplete="off" placeholder="e.g., House cleaning, TV mounting" class="h-11 w-full rounded-lg border border-slate-200 bg-white pl-3 pr-4 text-base text-slate-900 placeholder-slate-400 focus:border-[#0073e6] focus:outline-none focus:ring-1 focus:ring-[#0073e6]" aria-autocomplete="list" aria-controls="quote-service-suggestions" />
            <div id="quote-service-suggestions" role="listbox" class="absolute top-full left-0 right-0 z-20 mt-1 max-h-60 overflow-y-auto rounded-lg border border-slate-200 bg-white shadow-lg hidden"></div>
          </div>
          <div class="flex gap-3">
            <div class="flex-1"></div>
            <button type="button" class="quote-next flex-1 h-12 rounded-lg bg-[#f97415] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#ea580c] focus:outline-none focus:ring-2 focus:ring-[#f97415] focus:ring-offset-2" data-quote-goto="2">Continue →</button>
          </div>
          </div>

        <!-- Step 2: ZIP code -->
        <div id="quote-step-2" class="quote-step hidden space-y-6">
          <div class="text-center">
            <h2 class="font-display text-2xl font-bold text-slate-900 mb-2">Where is the project located?</h2>
            <p class="text-slate-500">Enter your service location ZIP code</p>
          </div>
          <div class="space-y-1.5">
            <label for="quote-zip" class="sr-only">ZIP code</label>
            <div class="relative">
              <span class="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" aria-hidden="true">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
                </span>
              <input type="text" id="quote-zip" name="zip" inputmode="numeric" pattern="[0-9]*" maxlength="5" placeholder="Enter ZIP code" class="h-11 w-full rounded-lg border border-slate-200 bg-white pl-12 pr-4 text-base text-slate-900 placeholder-slate-400 focus:border-[#0073e6] focus:outline-none focus:ring-1 focus:ring-[#0073e6]" />
            </div>
            <p id="quote-zip-error" class="text-sm text-red-500 hidden"></p>
          </div>
          <div class="flex gap-3">
            <button type="button" class="quote-back flex-1 h-12 rounded-lg border border-slate-300 px-4 py-2.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#0073e6] focus:ring-offset-2" data-quote-goto="1">← Back</button>
            <button type="button" class="quote-next flex-1 h-12 rounded-lg bg-[#f97415] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#ea580c] focus:outline-none focus:ring-2 focus:ring-[#f97415] focus:ring-offset-2" data-quote-goto="3">Continue →</button>
          </div>
        </div>

        <!-- Step 3: Project details + urgency -->
        <div id="quote-step-3" class="quote-step hidden space-y-6">
          <div class="text-center">
            <h2 class="font-display text-2xl font-bold text-slate-900 mb-2">Details for your Quote</h2>
            <p class="text-slate-500">Help us understand what you need</p>
      </div>
          <div class="space-y-3">
            <fieldset>
              <legend class="text-sm font-medium text-slate-700 mb-1">When do you need this done?</legend>
              <div class="flex flex-wrap gap-3">
                <label class="quote-urgency-card flex flex-1 min-w-[100px] cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-slate-200 bg-white px-4 py-3 transition has-[:checked]:border-red-500 has-[:checked]:bg-red-50 has-[:checked]:text-red-700 has-[:checked]:font-semibold">
                  <input type="radio" name="urgency" value="asap" class="peer sr-only" />
                  <span class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-slate-100 text-slate-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></span>
                  <span class="text-center text-sm">As soon as possible</span>
                </label>
                <label class="quote-urgency-card flex flex-1 min-w-[100px] cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-slate-200 bg-white px-4 py-3 transition has-[:checked]:border-[#0073e6] has-[:checked]:bg-[#0073e6]/5 has-[:checked]:text-[#0073e6] has-[:checked]:font-semibold">
                  <input type="radio" name="urgency" value="week" class="sr-only" checked />
                  <span class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-slate-100 text-slate-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></span>
                  <span class="text-center text-sm">Within a week</span>
                </label>
                <label class="quote-urgency-card flex flex-1 min-w-[100px] cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-slate-200 bg-white px-4 py-3 transition has-[:checked]:border-[#0073e6] has-[:checked]:bg-[#0073e6]/5 has-[:checked]:text-[#0073e6] has-[:checked]:font-semibold">
                  <input type="radio" name="urgency" value="flexible" class="sr-only" />
                  <span class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-slate-100 text-slate-600">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </span>
                  <span class="text-center text-sm">Flexible timing</span>
                </label>
              </div>
            </fieldset>
            <div>
              <label for="quote-details" class="block text-sm font-medium text-slate-700 mb-0.5">Tell us about your project</label>
              <textarea id="quote-details" name="details" rows="4" placeholder="Describe your project, any specific requirements, or questions you have..." class="w-full resize-y rounded-lg border border-slate-200 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-[#0073e6] focus:outline-none focus:ring-1 focus:ring-[#0073e6]"></textarea>
            </div>
          </div>
          <div class="flex gap-3">
            <button type="button" class="quote-back flex-1 h-12 rounded-lg border border-slate-300 px-4 py-2.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#0073e6] focus:ring-offset-2" data-quote-goto="2">← Back</button>
            <button type="button" class="quote-next flex-1 h-12 rounded-lg bg-[#f97415] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#ea580c] focus:outline-none focus:ring-2 focus:ring-[#f97415] focus:ring-offset-2" data-quote-goto="4">Continue →</button>
            </div>
          </div>

        <!-- Step 4: Contact info -->
        <div id="quote-step-4" class="quote-step hidden space-y-6">
          <div id="quote-step-4-form">
            <div class="w-full text-center">
              <span class="flex h-12 w-12 mx-auto mb-3 items-center justify-center rounded-full bg-emerald-100 text-emerald-600" aria-hidden="true">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
              </span>
              <h3 class="font-display text-2xl font-bold text-slate-900 mb-2 w-full text-center">Great News!<br>There are <span id="quote-pro-counter">0</span>+ Pros near you.</h3>
              <p class="text-slate-500 w-full text-center">Complete your details to get a quote</p>
            </div>
            <div class="space-y-3">
              <div>
                <label for="quote-name" class="block text-sm font-medium text-slate-700 mb-0.5">Your name</label>
                <input type="text" id="quote-name" name="name" required placeholder="John Doe" class="h-11 w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-[#0073e6] focus:outline-none focus:ring-1 focus:ring-[#0073e6]" />
              </div>
              <div>
                <label for="quote-email" class="block text-sm font-medium text-slate-700 mb-0.5">Email address</label>
                <input type="email" id="quote-email" name="email" required placeholder="john@example.com" class="h-11 w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-[#0073e6] focus:outline-none focus:ring-1 focus:ring-[#0073e6]" />
            </div>
            <div>
                <label for="quote-phone" class="block text-sm font-medium text-slate-700 mb-0.5">Phone number</label>
                <input type="tel" id="quote-phone" name="phone" required placeholder="(818) 555-1234" class="h-11 w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-[#0073e6] focus:outline-none focus:ring-1 focus:ring-[#0073e6]" />
              </div>
            </div>
            <div class="flex w-full gap-3">
              <button type="button" class="quote-back flex-1 min-w-0 h-12 rounded-lg border border-slate-300 px-4 py-2.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#0073e6] focus:ring-offset-2" data-quote-goto="3">← Back</button>
              <button type="submit" id="quote-submit-btn" class="flex-1 min-w-0 h-12 rounded-lg bg-[#f97415] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#ea580c] focus:outline-none focus:ring-2 focus:ring-[#f97415] focus:ring-offset-2 whitespace-nowrap">Get My Free Quote</button>
            </div>
            <p class="text-xs text-center text-slate-500">By submitting, you agree to our <a href="/terms/" class="text-[#0073e6] underline hover:no-underline">Terms of Service</a> and <a href="/privacy/" class="text-[#0073e6] underline hover:no-underline">Privacy Policy</a>.</p>
          </div>
          <div id="quote-step-4-success" class="hidden text-center py-4">
            <p class="text-lg font-semibold text-emerald-600 mb-2">Thanks, we will be in touch!</p>
            <p class="text-slate-500 text-sm">Redirecting...</p>
          </div>
          <div id="quote-step-4-error" class="hidden text-center py-4">
            <p class="text-red-600 font-medium mb-2">Something went wrong. Please try again or call us.</p>
            <button type="button" id="quote-try-again" class="rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">Try again</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</dialog>

<!-- Booking Modal (4-step: Service → ZIP → Details → Contact) -->
<dialog id="booking-modal" class="modal-dialog rounded-2xl border-0 bg-white p-0 shadow-2xl backdrop:bg-black/40 backdrop:backdrop-blur-sm sm:max-w-lg overflow-hidden" aria-labelledby="booking-modal-title" aria-describedby="booking-modal-desc">
  <div class="relative max-h-[90vh] w-full overflow-y-auto">
    <button type="button" class="modal-close absolute top-4 right-4 z-10 flex h-9 w-9 items-center justify-center rounded-full text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-[#004080]" aria-label="Close booking modal" data-close-dialog="booking-modal">
      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <form id="booking-form" method="post" action="https://formspree.io/f/YOUR_ENDPOINT_HERE">
      <input type="hidden" name="_subject" value="Booking request from Deals of Quality" />
      <input type="hidden" name="form_type" value="booking" />
      <input type="hidden" id="booking-hidden-category" name="category" value="" />
      <input type="hidden" id="booking-hidden-service" name="service" value="" />
      <input type="hidden" id="booking-hidden-zip" name="zip" value="" />

      <!-- Progress bar (4 steps: 25%, 50%, 75%, 100%) -->
      <div class="border-b border-slate-200 p-4">
        <div class="h-1.5 w-full overflow-hidden rounded-full bg-slate-200">
          <div id="booking-progress-fill" class="h-full rounded-full bg-[#004080] transition-all duration-300" style="width: 25%"></div>
        </div>
        <p id="booking-modal-desc" class="text-sm text-slate-500 mt-2 text-center">Step <span id="booking-step-indicator">1</span> of 4</p>
      </div>

      <div class="p-6 pr-14">
        <!-- Step 1: Service selection (free-text with suggestions, same as Quote modal) -->
        <div id="booking-step-1" class="booking-step space-y-6">
          <div class="text-center">
            <h2 id="booking-modal-title" class="font-display text-2xl font-bold text-slate-900 mb-2">What do you need help with?</h2>
            <p class="text-slate-500">Select a service to get matched with the right pro</p>
          </div>
          <div class="relative w-full">
            <label for="booking-service-input" class="block text-sm font-medium text-slate-700 mb-0.5">What type of service do you need?</label>
            <input type="text" id="booking-service-input" name="service_input" autocomplete="off" placeholder="e.g., House cleaning, TV mounting" class="h-11 w-full rounded-lg border border-slate-200 bg-white pl-3 pr-4 text-base text-slate-900 placeholder-slate-400 focus:border-[#004080] focus:outline-none focus:ring-1 focus:ring-[#004080]" aria-autocomplete="list" aria-controls="booking-service-suggestions" />
            <div id="booking-service-suggestions" role="listbox" class="absolute top-full left-0 right-0 z-20 mt-1 max-h-60 overflow-y-auto rounded-lg border border-slate-200 bg-white shadow-lg hidden"></div>
          </div>
          <div class="w-full pt-2">
            <button type="button" class="booking-next w-full h-12 rounded-lg bg-[#f97415] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#ea580c] focus:outline-none focus:ring-2 focus:ring-[#f97415] focus:ring-offset-2" data-booking-goto="2">Continue →</button>
          </div>
        </div>

        <!-- Step 2: ZIP code -->
        <div id="booking-step-2" class="booking-step hidden space-y-6">
          <div class="text-center">
            <h2 class="font-display text-2xl font-bold text-slate-900 mb-2">Where is the project located?</h2>
            <p class="text-slate-500">Enter your service location ZIP code</p>
          </div>
          <div class="space-y-1.5">
            <label for="booking-zip" class="sr-only">ZIP code</label>
            <div class="relative">
              <span class="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" aria-hidden="true">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
              </span>
              <input type="text" id="booking-zip" name="zip_input" inputmode="numeric" pattern="[0-9]*" maxlength="5" placeholder="Enter ZIP code" class="h-11 w-full rounded-lg border border-slate-200 bg-white pl-12 pr-4 text-base text-slate-900 placeholder-slate-400 focus:border-[#004080] focus:outline-none focus:ring-1 focus:ring-[#004080]" />
            </div>
            <p id="booking-zip-error" class="text-sm text-red-500 hidden"></p>
          </div>
          <div class="flex w-full gap-3 pt-2">
            <button type="button" class="booking-back flex-1 min-w-0 h-12 rounded-lg border border-slate-300 px-4 py-2.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#004080] focus:ring-offset-2" data-booking-goto="1">← Back</button>
            <button type="button" class="booking-next flex-1 min-w-0 h-12 rounded-lg bg-[#f97415] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#ea580c] focus:outline-none focus:ring-2 focus:ring-[#f97415] focus:ring-offset-2" data-booking-goto="3">Continue →</button>
          </div>
        </div>

        <!-- Step 3: Details (timing + project description) -->
        <div id="booking-step-3" class="booking-step hidden space-y-6">
          <div class="text-center">
            <h2 class="font-display text-2xl font-bold text-slate-900 mb-2">Details for your Service Request</h2>
            <p class="text-slate-500">Help us understand what you need</p>
          </div>
          <div class="space-y-3">
            <fieldset>
              <legend class="text-sm font-medium text-slate-700 mb-1">When do you need this done?</legend>
              <div class="flex flex-wrap gap-3">
                <label class="booking-timing-card flex flex-1 min-w-[100px] cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-slate-200 bg-white px-4 py-3 transition has-[:checked]:border-[#004080] has-[:checked]:bg-blue-50 has-[:checked]:text-[#004080] has-[:checked]:font-semibold">
                  <input type="radio" name="preferred_timing" value="asap" class="peer sr-only" />
                  <span class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-slate-100 text-slate-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></span>
                  <span class="text-center text-sm">As soon as possible</span>
                </label>
                <label class="booking-timing-card flex flex-1 min-w-[100px] cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-slate-200 bg-white px-4 py-3 transition has-[:checked]:border-[#004080] has-[:checked]:bg-blue-50 has-[:checked]:text-[#004080] has-[:checked]:font-semibold">
                  <input type="radio" name="preferred_timing" value="week" class="peer sr-only" checked />
                  <span class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-slate-100 text-slate-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></span>
                  <span class="text-center text-sm">Within a week</span>
                </label>
                <label class="booking-timing-card flex flex-1 min-w-[100px] cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-slate-200 bg-white px-4 py-3 transition has-[:checked]:border-[#004080] has-[:checked]:bg-blue-50 has-[:checked]:text-[#004080] has-[:checked]:font-semibold">
                  <input type="radio" name="preferred_timing" value="flexible" class="peer sr-only" />
                  <span class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-slate-100 text-slate-600">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  </span>
                  <span class="text-center text-sm">Flexible timing</span>
                </label>
              </div>
            </fieldset>
            <div>
              <label for="booking-details" class="block text-sm font-medium text-slate-700 mb-0.5">Tell us about your project</label>
              <textarea id="booking-details" name="details" rows="4" placeholder="Describe your project, any specific requirements, or questions you have..." class="w-full resize-y rounded-lg border border-slate-200 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-[#004080] focus:outline-none focus:ring-1 focus:ring-[#004080]"></textarea>
            </div>
          </div>
          <div class="flex w-full gap-3 pt-2">
            <button type="button" class="booking-back flex-1 min-w-0 h-12 rounded-lg border border-slate-300 px-4 py-2.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#004080] focus:ring-offset-2" data-booking-goto="2">← Back</button>
            <button type="button" class="booking-next flex-1 min-w-0 h-12 rounded-lg bg-[#f97415] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#ea580c] focus:outline-none focus:ring-2 focus:ring-[#f97415] focus:ring-offset-2" data-booking-goto="4">Continue →</button>
          </div>
        </div>

        <!-- Step 4: Contact info + submit -->
        <div id="booking-step-4" class="booking-step hidden space-y-6">
          <div id="booking-step-4-form">
            <div class="w-full text-center">
              <h2 class="font-display text-2xl font-bold text-slate-900 mb-2 w-full text-center">Great News! There are <span id="booking-pro-counter">0</span>+ Pros available.</h2>
              <p class="text-slate-500 w-full text-center">Complete your details to book your appointment</p>
            </div>
            <div class="space-y-3">
              <div>
                <label for="booking-name" class="block text-sm font-medium text-slate-700 mb-0.5">Full Name *</label>
                <input type="text" id="booking-name" name="name" required placeholder="John Doe" class="h-11 w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-[#004080] focus:outline-none focus:ring-1 focus:ring-[#004080]" />
              </div>
              <div>
                <label for="booking-email" class="block text-sm font-medium text-slate-700 mb-0.5">Email Address *</label>
                <input type="email" id="booking-email" name="email" required placeholder="john@example.com" class="h-11 w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-[#004080] focus:outline-none focus:ring-1 focus:ring-[#004080]" />
              </div>
              <div>
                <label for="booking-phone" class="block text-sm font-medium text-slate-700 mb-0.5">Phone Number *</label>
                <input type="tel" id="booking-phone" name="phone" required placeholder="(818) 555-1234" class="h-11 w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-[#004080] focus:outline-none focus:ring-1 focus:ring-[#004080]" />
              </div>
            </div>
            <div class="flex w-full gap-3 pt-2">
              <button type="button" class="booking-back flex-1 min-w-0 h-12 rounded-lg border border-slate-300 px-4 py-2.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#004080] focus:ring-offset-2" data-booking-goto="3">← Back</button>
              <button type="submit" id="booking-submit-btn" class="flex-1 min-w-0 h-12 rounded-lg bg-[#004080] px-5 py-2.5 text-base font-semibold text-white transition hover:bg-[#003366] focus:outline-none focus:ring-2 focus:ring-[#004080] focus:ring-offset-2 whitespace-nowrap">Request Appointment</button>
            </div>
            <p class="text-xs text-center text-slate-500">By submitting, you agree to our <a href="/terms/" class="text-[#0073e6] underline hover:no-underline">Terms of Service</a> and <a href="/privacy/" class="text-[#0073e6] underline hover:no-underline">Privacy Policy</a>.</p>
          </div>
          <div id="booking-step-4-success" class="hidden text-center py-4">
            <p class="text-lg font-semibold text-emerald-600 mb-2">Thanks, we will be in touch!</p>
            <p class="text-slate-500 text-sm">Redirecting...</p>
          </div>
          <div id="booking-step-4-error" class="hidden text-center py-4">
            <p class="text-red-600 font-medium mb-2">Something went wrong. Please try again or call us.</p>
            <button type="button" id="booking-try-again" class="rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">Try again</button>
          </div>
      </div>
    </div>
    </form>
  </div>
</dialog>

<script define:vars={{ services }}>
  (function () {
    var QUOTE_ID = 'quote-modal';
    var BOOKING_ID = 'booking-modal';
    var TOTAL_STEPS = 4;
    var BOOKING_STEPS = 4;
    var serviceList = Array.isArray(services) ? services : [];

    function getTvMountingConfigSummary() {
      var hasTvForm = document.querySelector('input[name="tv-size"]');
      if (!hasTvForm) return '';

      var sizeMap = {
        'under-50': 'Under 50" (Smaller TV)',
        '51-65': '51\"–65\" (Medium TV)',
        'over-65': 'Over 65\" (Large TV)',
      };
      var bracketMap = {
        own: 'I have my own mounting bracket',
        flat: 'Flat Bracket ($30)',
        tilting: 'Tilting Bracket ($45)',
        'full-motion': 'Full-motion Bracket ($65)',
      };
      var locationMap = {
        drywall: 'On Drywall',
        brick: 'On Brick/Concrete (+$35)',
        fireplace: 'Above a Fireplace (+$50)',
      };
      var addonMap = {
        'no-wire-hiding': 'No wire hiding',
        raceway: 'Hide Wires in wall cover/raceway (+$30)',
        'in-wall': 'Hide Wires In-wall (+$80)',
        dismount: 'Dismount Old TV (+$35)',
        soundbar: 'Soundbar Installation (+$50)',
      };

      var sizeEl = document.querySelector('input[name="tv-size"]:checked');
      var bracketEl = document.querySelector('input[name="bracket"]:checked');
      var locationEl = document.querySelector('input[name="mount-location"]:checked');
      var addonEls = Array.prototype.slice.call(document.querySelectorAll('input[name="addon"]:checked'));

      var lines = [];
      if (sizeEl) lines.push('TV Size: ' + (sizeMap[sizeEl.value] || sizeEl.value));
      if (bracketEl) lines.push('Bracket: ' + (bracketMap[bracketEl.value] || bracketEl.value));
      if (locationEl) lines.push('Mounting Location: ' + (locationMap[locationEl.value] || locationEl.value));

      if (addonEls.length) {
        var addons = addonEls
          .map(function (el) {
            return addonMap[el.value] || el.value;
          })
          .join(', ');
        lines.push('Add-ons: ' + addons);
      }

      var priceEl = document.getElementById('tv-install-price');
      if (priceEl && priceEl.textContent) {
        lines.push('Estimated starting price: ' + priceEl.textContent.replace(/^From\\s*/i, ''));
      }

      return lines.join('\n');
    }

    function lockBodyScroll(lock) {
      document.body.style.overflow = lock ? 'hidden' : '';
    }

    function openDialog(id) {
      var dialog = document.getElementById(id);
      if (dialog && typeof dialog.showModal === 'function') {
        dialog.showModal();
        lockBodyScroll(true);
      }
    }

    function closeDialog(id) {
      var dialog = document.getElementById(id);
      if (dialog && typeof dialog.close === 'function') {
        dialog.close();
        lockBodyScroll(false);
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
          document.activeElement.blur();
        }
      }
    }

    function setQuoteStep(step) {
      for (var i = 1; i <= TOTAL_STEPS; i++) {
        var el = document.getElementById('quote-step-' + i);
        if (el) el.classList.toggle('hidden', i !== step);
      }
    }

    function prevQuoteStep(step) {
      setQuoteStep(step);
    }

    function animateCounter(targetId, minVal, maxVal) {
      var el = document.getElementById(targetId);
      if (!el) return;
      el.textContent = '0';
      var target = minVal + Math.floor(Math.random() * (maxVal - minVal + 1));
      var duration = 2500 + Math.random() * 500;
      var start = performance.now();
      function tick(now) {
        var t = Math.min((now - start) / duration, 1);
        var eased = 1 - Math.pow(1 - t, 1.5);
        var current = Math.round(eased * target);
        el.textContent = String(current);
        if (t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function resetQuoteModal() {
      setQuoteStep(1);
      var form = document.getElementById('quote-form');
      if (form) form.reset();
      var zipErr = document.getElementById('quote-zip-error');
      if (zipErr) { zipErr.classList.add('hidden'); zipErr.textContent = ''; }
      var serviceInput = document.getElementById('quote-service-input');
      if (serviceInput) serviceInput.value = '';
      var suggestionsEl = document.getElementById('quote-service-suggestions');
      if (suggestionsEl) { suggestionsEl.classList.add('hidden'); suggestionsEl.innerHTML = ''; }
      var hiddenService = document.getElementById('quote-hidden-service');
      if (hiddenService) hiddenService.value = '';
      var findingEl = document.getElementById('quote-finding-pros');
      if (findingEl) findingEl.classList.add('hidden');
      var quoteProCounter = document.getElementById('quote-pro-counter');
      if (quoteProCounter) quoteProCounter.textContent = '0';
      var formBlock = document.getElementById('quote-step-4-form');
      var successBlock = document.getElementById('quote-step-4-success');
      var errorBlock = document.getElementById('quote-step-4-error');
      var submitBtn = document.getElementById('quote-submit-btn');
      if (formBlock) formBlock.classList.remove('hidden');
      if (successBlock) successBlock.classList.add('hidden');
      if (errorBlock) errorBlock.classList.add('hidden');
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Get My Free Quote'; }
    }

    function setBookingStep(step) {
      var progressFill = document.getElementById('booking-progress-fill');
      if (progressFill) progressFill.style.width = (step / BOOKING_STEPS * 100) + '%';
      var indicator = document.getElementById('booking-step-indicator');
      if (indicator) indicator.textContent = String(step);
      for (var i = 1; i <= BOOKING_STEPS; i++) {
        var el = document.getElementById('booking-step-' + i);
        if (el) el.classList.toggle('hidden', i !== step);
      }
    }

    function prevBookingStep(step) {
      setBookingStep(step);
    }

    function resetBookingModal() {
      setBookingStep(1);
      var form = document.getElementById('booking-form');
      if (form) form.reset();
      var zipErr = document.getElementById('booking-zip-error');
      if (zipErr) { zipErr.classList.add('hidden'); zipErr.textContent = ''; }
      var serviceInput = document.getElementById('booking-service-input');
      if (serviceInput) serviceInput.value = '';
      var suggestionsEl = document.getElementById('booking-service-suggestions');
      if (suggestionsEl) { suggestionsEl.classList.add('hidden'); suggestionsEl.innerHTML = ''; }
      var hiddenService = document.getElementById('booking-hidden-service');
      if (hiddenService) hiddenService.value = '';
      var bookingProCounter = document.getElementById('booking-pro-counter');
      if (bookingProCounter) bookingProCounter.textContent = '0';
      var formBlock = document.getElementById('booking-step-4-form');
      var successBlock = document.getElementById('booking-step-4-success');
      var errorBlock = document.getElementById('booking-step-4-error');
      var submitBtn = document.getElementById('booking-submit-btn');
      if (formBlock) formBlock.classList.remove('hidden');
      if (successBlock) successBlock.classList.add('hidden');
      if (errorBlock) errorBlock.classList.add('hidden');
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Request Appointment'; }
    }

    function renderServiceSuggestions(inputEl, listboxEl, hiddenServiceEl, value) {
      if (!listboxEl) return;
      var val = (value || '').trim().toLowerCase();
      listboxEl.innerHTML = '';
      var added = {};
      for (var i = 0; i < serviceList.length; i++) {
        var s = serviceList[i];
        var label = (s.label || s.value || '').trim();
        if (!label || added[label]) continue;
        if (!val || label.toLowerCase().indexOf(val) !== -1) {
          added[label] = true;
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.role = 'option';
          btn.className = 'w-full text-left px-4 py-3 text-base text-slate-900 hover:bg-slate-100 border-b border-slate-100 last:border-0 transition-colors';
          btn.textContent = label;
          btn.dataset.value = label;
          btn.dataset.rawValue = (s.value || s.label || '').trim();
          listboxEl.appendChild(btn);
        }
      }
      if (val && Object.keys(added).length === 0) {
        var trimmed = (value || '').trim();
        var useBtn = document.createElement('button');
        useBtn.type = 'button';
        useBtn.role = 'option';
        useBtn.className = 'w-full text-left px-4 py-3 text-base font-medium text-slate-900 hover:bg-slate-100 border-t border-slate-200 transition-colors';
        useBtn.textContent = 'Use "' + trimmed.slice(0, 80) + (trimmed.length > 80 ? '…' : '') + '"';
        useBtn.dataset.value = trimmed;
        useBtn.dataset.rawValue = trimmed;
        listboxEl.appendChild(useBtn);
      }
      listboxEl.classList.toggle('hidden', listboxEl.children.length === 0);
    }

    function setupServiceInput(inputId, suggestionsId, hiddenId) {
      var inputEl = document.getElementById(inputId);
      var listboxEl = document.getElementById(suggestionsId);
      var hiddenEl = document.getElementById(hiddenId);
      if (!inputEl || !listboxEl) return;
      inputEl.addEventListener('focus', function () {
        renderServiceSuggestions(inputEl, listboxEl, hiddenEl, inputEl.value);
      });
      inputEl.addEventListener('input', function () {
        renderServiceSuggestions(inputEl, listboxEl, hiddenEl, inputEl.value);
        var v = inputEl.value.trim();
        if (hiddenEl) hiddenEl.value = v;
        if (hiddenId === 'booking-hidden-service') {
          var catEl = document.getElementById('booking-hidden-category');
          if (catEl) catEl.value = v;
        }
      });
      inputEl.addEventListener('blur', function () {
        setTimeout(function () {
          listboxEl.classList.add('hidden');
        }, 180);
      });
      listboxEl.addEventListener('mousedown', function (e) {
        var opt = e.target.closest('button[role="option"]');
        if (opt && opt.dataset.value !== undefined) {
          e.preventDefault();
          inputEl.value = opt.dataset.value;
          var v = (opt.dataset.rawValue !== undefined ? opt.dataset.rawValue : opt.dataset.value) || inputEl.value;
          if (hiddenEl) hiddenEl.value = v;
          if (hiddenId === 'booking-hidden-service') {
            var catEl = document.getElementById('booking-hidden-category');
            if (catEl) catEl.value = v;
          }
          listboxEl.classList.add('hidden');
          listboxEl.innerHTML = '';
        }
      });
    }
    setupServiceInput('quote-service-input', 'quote-service-suggestions', 'quote-hidden-service');
    setupServiceInput('booking-service-input', 'booking-service-suggestions', 'booking-hidden-service');

    // When Hero opens the modal with service + zip: prefill and skip steps 1 & 2 to step 3
    document.addEventListener('quote-modal-opened-with-hero-data', function (e) {
      var service = (e.detail && e.detail.service) ? String(e.detail.service).trim() : '';
      var zip = (e.detail && e.detail.zip) ? String(e.detail.zip).replace(/\D/g, '').slice(0, 5) : '';
      var quoteServiceInput = document.getElementById('quote-service-input');
      var quoteHiddenService = document.getElementById('quote-hidden-service');
      var quoteHiddenZip = document.getElementById('quote-hidden-zip');
      var quoteZipInput = document.getElementById('quote-zip');
      var quoteDetails = document.getElementById('quote-details');
      if (quoteServiceInput && service) quoteServiceInput.value = service;
      if (quoteHiddenService && service) quoteHiddenService.value = service;
      if (quoteHiddenZip && zip) quoteHiddenZip.value = zip;
      if (quoteZipInput && zip) quoteZipInput.value = zip;
      if (quoteDetails && service) quoteDetails.value = service;
      setQuoteStep(3);
    });

    // Open quote modal at step 3 with service + zip pre-filled (e.g. tech-support page)
    document.addEventListener('open-quote-modal-step-3', function (e) {
      var service = (e.detail && e.detail.service) ? String(e.detail.service).trim() : '';
      var zip = (e.detail && e.detail.zip) ? String(e.detail.zip).replace(/\D/g, '').slice(0, 5) : '';
      resetQuoteModal();
      openDialog(QUOTE_ID);
      var quoteServiceInput = document.getElementById('quote-service-input');
      var quoteHiddenService = document.getElementById('quote-hidden-service');
      var quoteHiddenZip = document.getElementById('quote-hidden-zip');
      var quoteZipInput = document.getElementById('quote-zip');
      var quoteDetails = document.getElementById('quote-details');
      if (quoteServiceInput && service) quoteServiceInput.value = service;
      if (quoteHiddenService && service) quoteHiddenService.value = service;
      if (quoteHiddenZip && zip) quoteHiddenZip.value = zip;
      if (quoteZipInput && zip) quoteZipInput.value = zip;
      if (quoteDetails && service) quoteDetails.value = service;
      setQuoteStep(3);
    });

    // Open: distinct triggers for Quote vs Booking
    document.addEventListener('click', function (e) {
      var openQuote = e.target.closest('[data-open-quote="true"]') || e.target.closest('[data-open-quote]');
      var openBooking = e.target.closest('[data-open-booking="true"]') || e.target.closest('[data-open-booking]');
      if (openQuote) {
        e.preventDefault();
        e.stopPropagation();
        resetQuoteModal();
        var serviceName = openQuote.getAttribute('data-service');
        if (serviceName && serviceName.trim()) {
          var serviceInput = document.getElementById('quote-service-input');
          var hiddenService = document.getElementById('quote-hidden-service');
          if (serviceInput) {
            serviceInput.value = serviceName.trim();
            if (hiddenService) hiddenService.value = serviceName.trim();
          }
        }
        openDialog(QUOTE_ID);
        var quoteStep = openQuote.getAttribute('data-quote-step');
        if (quoteStep === '2') setQuoteStep(2);
        var summary = getTvMountingConfigSummary();
        if (summary) {
          var quoteDetails = document.getElementById('quote-details');
          if (quoteDetails) {
            var existing = quoteDetails.value && quoteDetails.value.trim();
            quoteDetails.value = existing ? summary + '\\n\\n' + existing : summary;
          }
        }
      }
      if (openBooking) {
        e.preventDefault();
        e.stopPropagation();
        resetBookingModal();
        var serviceName = openBooking.getAttribute('data-service');
        if (serviceName && typeof serviceName === 'string' && serviceName.trim()) {
          var serviceInput = document.getElementById('booking-service-input');
          var hiddenService = document.getElementById('booking-hidden-service');
          if (serviceInput) {
            serviceInput.value = serviceName.trim();
            if (hiddenService) hiddenService.value = serviceName.trim();
          }
        }
        openDialog(BOOKING_ID);
        var bookingSummary = getTvMountingConfigSummary();
        if (bookingSummary) {
          var bookingDetails = document.getElementById('booking-details');
          if (bookingDetails) {
            var existingDetails = bookingDetails.value && bookingDetails.value.trim();
            bookingDetails.value = existingDetails ? bookingSummary + '\\n\\n' + existingDetails : bookingSummary;
          }
        }
      }
    });

    // Switch: Quote modal → Booking modal
    document.addEventListener('click', function (e) {
      if (e.target.closest('[data-switch-to-booking]')) {
        e.preventDefault();
        closeDialog(QUOTE_ID);
        resetQuoteModal();
        openDialog(BOOKING_ID);
      }
    });

    // Switch: Booking modal → Quote modal
    document.addEventListener('click', function (e) {
      if (e.target.closest('[data-switch-to-quote]')) {
        e.preventDefault();
        closeDialog(BOOKING_ID);
        resetQuoteModal();
        openDialog(QUOTE_ID);
      }
    });

    // Close: X button (data-close-dialog) or backdrop click
    document.addEventListener('click', function (e) {
      var closeBtn = e.target.closest('[data-close-dialog]');
      if (closeBtn) {
        var id = closeBtn.getAttribute('data-close-dialog');
        if (id) {
          closeDialog(id);
          if (id === QUOTE_ID) resetQuoteModal();
          if (id === BOOKING_ID) resetBookingModal();
        }
        return;
      }
      var dialog = e.target;
      if (dialog && dialog.nodeName === 'DIALOG' && dialog.open && dialog.id && (dialog.id === QUOTE_ID || dialog.id === BOOKING_ID)) {
        closeDialog(dialog.id);
        if (dialog.id === QUOTE_ID) resetQuoteModal();
        if (dialog.id === BOOKING_ID) resetBookingModal();
      }
    });

    document.addEventListener('close', function (e) {
      var dialog = e.target;
      if (dialog && dialog.nodeName === 'DIALOG' && (dialog.id === QUOTE_ID || dialog.id === BOOKING_ID)) {
        lockBodyScroll(false);
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
          document.activeElement.blur();
        }
        if (dialog.id === QUOTE_ID) resetQuoteModal();
        if (dialog.id === BOOKING_ID) resetBookingModal();
      }
    });

    // Quote modal: Next / Back (type="button" so they don't submit)
    var quoteForm = document.getElementById('quote-form');
    if (quoteForm) {
      quoteForm.addEventListener('click', function (e) {
        var nextBtn = e.target.closest('.quote-next[data-quote-goto]');
        var backBtn = e.target.closest('.quote-back[data-quote-goto]');
        if (nextBtn) {
          e.preventDefault();
          var goto = parseInt(nextBtn.getAttribute('data-quote-goto'), 10);
          if (goto === 4) {
            var findingEl = document.getElementById('quote-finding-pros');
            if (findingEl) {
              findingEl.classList.remove('hidden');
              setTimeout(function () {
                findingEl.classList.add('hidden');
                setQuoteStep(4);
                animateCounter('quote-pro-counter', 14, 32);
              }, 1500);
            } else {
              setQuoteStep(4);
              animateCounter('quote-pro-counter', 14, 32);
            }
            return;
          }
          if (goto === 2) {
            var serviceInput = document.getElementById('quote-service-input');
            var hiddenService = document.getElementById('quote-hidden-service');
            if (serviceInput && !serviceInput.value.trim()) return;
            if (hiddenService) hiddenService.value = (serviceInput && serviceInput.value.trim()) || '';
          }
          if (goto === 3) {
            var zipInput = document.getElementById('quote-zip');
            var zipErr = document.getElementById('quote-zip-error');
            if (zipInput && zipInput.value.replace(/\D/g, '').length !== 5) {
              if (zipErr) { zipErr.textContent = 'Please enter a 5-digit ZIP code'; zipErr.classList.remove('hidden'); }
              return;
            }
            var zipNum = parseInt(zipInput.value.replace(/\D/g, ''), 10);
            if (zipNum < 501 || zipNum > 99950) {
              if (zipErr) { zipErr.textContent = 'Please enter a valid US ZIP code (00501-99950)'; zipErr.classList.remove('hidden'); }
              return;
            }
            if (zipErr) { zipErr.classList.add('hidden'); zipErr.textContent = ''; }
          }
          setQuoteStep(goto);
          return;
        }
        if (backBtn) {
          e.preventDefault();
          var goto = parseInt(backBtn.getAttribute('data-quote-goto'), 10);
          prevQuoteStep(goto);
        }
      });

      var quoteServiceInput = document.getElementById('quote-service-input');
      var quoteHiddenService = document.getElementById('quote-hidden-service');
      if (quoteServiceInput && quoteHiddenService) {
        quoteServiceInput.addEventListener('change', function () {
          quoteHiddenService.value = quoteServiceInput.value.trim();
        });
      }
      var zipInput = document.getElementById('quote-zip');
      if (zipInput) {
        zipInput.addEventListener('input', function () {
          this.value = this.value.replace(/\D/g, '').slice(0, 5);
        });
      }
      quoteForm.addEventListener('submit', function (e) {
        e.preventDefault();
        var qs = document.getElementById('quote-service-input');
        var qh = document.getElementById('quote-hidden-service');
        var qz = document.getElementById('quote-zip');
        var qzHidden = document.getElementById('quote-hidden-zip');
        if (qs && qh) qh.value = qs.value.trim();
        if (qz && qzHidden) qzHidden.value = qz.value.replace(/\D/g, '').slice(0, 5);
        var formBlock = document.getElementById('quote-step-4-form');
        var successBlock = document.getElementById('quote-step-4-success');
        var errorBlock = document.getElementById('quote-step-4-error');
        var submitBtn = document.getElementById('quote-submit-btn');
        var urgencyRadio = quoteForm.querySelector('input[name="urgency"]:checked');
        var payload = {
          formType: 'quote',
          name: (document.getElementById('quote-name') && document.getElementById('quote-name').value) || '',
          email: (document.getElementById('quote-email') && document.getElementById('quote-email').value) || '',
          phone: (document.getElementById('quote-phone') && document.getElementById('quote-phone').value) || '',
          service: (document.getElementById('quote-hidden-service') && document.getElementById('quote-hidden-service').value) || '',
          zip: (document.getElementById('quote-hidden-zip') && document.getElementById('quote-hidden-zip').value) || '',
          urgency: (urgencyRadio && urgencyRadio.value) || '',
          details: (document.getElementById('quote-details') && document.getElementById('quote-details').value) || ''
        };
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Sending...'; }
        fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(function (res) {
          if (res.ok) {
            if (formBlock) formBlock.classList.add('hidden');
            if (errorBlock) errorBlock.classList.add('hidden');
            if (successBlock) successBlock.classList.remove('hidden');
            setTimeout(function () {
            closeDialog(QUOTE_ID);
              resetQuoteModal();
              window.location.href = '/quote-received/';
            }, 1500);
          } else {
            if (formBlock) formBlock.classList.add('hidden');
            if (successBlock) successBlock.classList.add('hidden');
            if (errorBlock) errorBlock.classList.remove('hidden');
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Get My Free Quote'; }
          }
        }).catch(function () {
          if (formBlock) formBlock.classList.add('hidden');
          if (successBlock) successBlock.classList.add('hidden');
          if (errorBlock) errorBlock.classList.remove('hidden');
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Get My Free Quote'; }
        });
      });
      document.getElementById('quote-try-again') && document.getElementById('quote-try-again').addEventListener('click', function () {
        document.getElementById('quote-step-4-form').classList.remove('hidden');
        document.getElementById('quote-step-4-error').classList.add('hidden');
      });
    }

    // Booking modal: Next / Back (4 steps) and submit
    var bookingForm = document.getElementById('booking-form');
    if (bookingForm) {
      bookingForm.addEventListener('click', function (e) {
        var nextBtn = e.target.closest('.booking-next[data-booking-goto]');
        var backBtn = e.target.closest('.booking-back[data-booking-goto]');
        if (nextBtn) {
          e.preventDefault();
          var goto = parseInt(nextBtn.getAttribute('data-booking-goto'), 10);
          if (goto === 2) {
            var serviceInput = document.getElementById('booking-service-input');
            var hiddenService = document.getElementById('booking-hidden-service');
            if (serviceInput && !serviceInput.value.trim()) return;
            if (hiddenService) hiddenService.value = (serviceInput && serviceInput.value.trim()) || '';
          }
          if (goto === 3) {
            var zipInput = document.getElementById('booking-zip');
            var zipErr = document.getElementById('booking-zip-error');
            if (!zipInput || zipInput.value.replace(/\D/g, '').length !== 5) {
              if (zipErr) { zipErr.textContent = 'Please enter a 5-digit ZIP code'; zipErr.classList.remove('hidden'); }
              return;
            }
            var zipNum = parseInt(zipInput.value.replace(/\D/g, ''), 10);
            if (zipNum < 501 || zipNum > 99950) {
              if (zipErr) { zipErr.textContent = 'Please enter a valid US ZIP code (00501-99950)'; zipErr.classList.remove('hidden'); }
              return;
            }
            if (zipErr) { zipErr.classList.add('hidden'); zipErr.textContent = ''; }
          }
          setBookingStep(goto);
          if (goto === 4) animateCounter('booking-pro-counter', 25, 45);
          return;
        }
        if (backBtn) {
          e.preventDefault();
          var goto = parseInt(backBtn.getAttribute('data-booking-goto'), 10);
          prevBookingStep(goto);
        }
      });

      var bookingZip = document.getElementById('booking-zip');
      if (bookingZip) {
        bookingZip.addEventListener('input', function () {
          this.value = this.value.replace(/\D/g, '').slice(0, 5);
        });
      }

      bookingForm.addEventListener('submit', function (e) {
        e.preventDefault();
        var bs = document.getElementById('booking-service-input');
        var bh = document.getElementById('booking-hidden-service');
        var bc = document.getElementById('booking-hidden-category');
        var bz = document.getElementById('booking-zip');
        var bzHidden = document.getElementById('booking-hidden-zip');
        if (bs && bh) bh.value = bs.value.trim();
        if (bs && bc) bc.value = bs.value.trim();
        if (bz && bzHidden) bzHidden.value = bz.value.replace(/\D/g, '').slice(0, 5);
        var formBlock = document.getElementById('booking-step-4-form');
        var successBlock = document.getElementById('booking-step-4-success');
        var errorBlock = document.getElementById('booking-step-4-error');
        var submitBtn = document.getElementById('booking-submit-btn');
        var timingRadio = bookingForm.querySelector('input[name="preferred_timing"]:checked');
        var payload = {
          formType: 'booking',
          name: (document.getElementById('booking-name') && document.getElementById('booking-name').value) || '',
          email: (document.getElementById('booking-email') && document.getElementById('booking-email').value) || '',
          phone: (document.getElementById('booking-phone') && document.getElementById('booking-phone').value) || '',
          service: (document.getElementById('booking-hidden-service') && document.getElementById('booking-hidden-service').value) || '',
          category: (document.getElementById('booking-hidden-category') && document.getElementById('booking-hidden-category').value) || '',
          zip: (document.getElementById('booking-hidden-zip') && document.getElementById('booking-hidden-zip').value) || '',
          preferredTiming: (timingRadio && timingRadio.value) || '',
          details: (document.getElementById('booking-details') && document.getElementById('booking-details').value) || ''
        };
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Sending...'; }
        fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(function (res) {
          if (res.ok) {
            if (formBlock) formBlock.classList.add('hidden');
            if (errorBlock) errorBlock.classList.add('hidden');
            if (successBlock) successBlock.classList.remove('hidden');
            setTimeout(function () {
              closeDialog(BOOKING_ID);
              resetBookingModal();
              window.location.href = '/booking-confirmed/';
            }, 1500);
          } else {
            if (formBlock) formBlock.classList.add('hidden');
            if (successBlock) successBlock.classList.add('hidden');
            if (errorBlock) errorBlock.classList.remove('hidden');
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Request Appointment'; }
          }
        }).catch(function () {
          if (formBlock) formBlock.classList.add('hidden');
          if (successBlock) successBlock.classList.add('hidden');
          if (errorBlock) errorBlock.classList.remove('hidden');
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Request Appointment'; }
        });
      });
      document.getElementById('booking-try-again') && document.getElementById('booking-try-again').addEventListener('click', function () {
        document.getElementById('booking-step-4-form').classList.remove('hidden');
        document.getElementById('booking-step-4-error').classList.add('hidden');
      });
    }
  })();
</script>
