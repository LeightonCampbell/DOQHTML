---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const sorted = [...allPosts].sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// Group by category; preserve order: Website & Business, Computers & Tech, TV Mounting, Handyman, Home Improvement
const categoryOrder = ['Website & Business', 'Computers & Tech', 'TV Mounting', 'Handyman', 'Home Improvement'];
const byCategory = new Map<string, typeof sorted>();
for (const entry of sorted) {
  const cat = entry.data.category;
  if (!byCategory.has(cat)) byCategory.set(cat, []);
  byCategory.get(cat)!.push(entry);
}
const orderedCategories = categoryOrder.filter((c) => byCategory.has(c));
const remainingCats = [...byCategory.keys()].filter((c) => !categoryOrder.includes(c));
const categories = [...orderedCategories, ...remainingCats];

const formatDate = (d: Date) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

// Placeholder when no hero/image: use a simple gradient so cards have consistent height
const defaultImage = '/blog/placeholder-article.svg';
---

<BaseLayout
  title="Articles | Tips & Insights | Deals Of Quality"
  description="Expert insights on business growth, technology, TV mounting, and local services. Browse articles by category."
  canonical="https://www.dealsofquality.com/articles/"
>
  <main class="flex-1">
    <!-- Hero -->
    <section class="bg-secondary/30 relative overflow-hidden pt-24 pb-12 md:pt-32 md:pb-16">
      <div class="absolute top-0 right-0 w-[400px] h-[400px] bg-accent/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2" aria-hidden="true"></div>
      <div class="container-max px-4 md:px-8 lg:px-16 relative z-10">
        <div class="max-w-3xl mx-auto text-center">
          <h1 class="font-display text-4xl md:text-5xl font-bold text-foreground mb-4">
            Articles
          </h1>
          <p class="text-muted-foreground text-lg">
            Tips and insights to help you find a quality solution for every service need.
          </p>
        </div>
      </div>
    </section>

    <!-- Articles by category -->
    <section class="section-padding bg-background">
      <div class="container-max px-4 md:px-8 lg:px-16">
        {categories.map((category) => {
          const posts = byCategory.get(category)!;
          return (
            <div class="mb-14 last:mb-0">
              <h2 class="font-display text-2xl md:text-3xl font-bold text-foreground mb-6">
                {category}
              </h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-[10px] gap-y-6 articles-grid">
                {posts.map((entry) => {
                  const img = entry.data.heroImage ?? entry.data.image ?? defaultImage;
                  return (
                    <a href={`/blog/${entry.slug}/`} class="group block">
                      <article class="bg-card border border-border rounded-2xl overflow-hidden hover:shadow-lg transition-shadow h-full flex flex-col">
                        <!-- 1. Image (top) -->
                        <div class="aspect-video bg-muted relative overflow-hidden">
                          {img.startsWith('/') && !img.includes('placeholder') ? (
                            <img
                              src={img}
                              alt=""
                              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                              loading="lazy"
                            />
                          ) : (
                            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-accent/20 to-secondary/30" aria-hidden="true">
                              <svg class="w-12 h-12 text-muted-foreground/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                              </svg>
                            </div>
                          )}
                        </div>
                        <div class="p-5 flex-1 flex flex-col">
                          <time class="text-xs uppercase tracking-wide text-muted-foreground mb-2 block" datetime={entry.data.pubDate.toISOString()}>
                            {formatDate(entry.data.pubDate)}
                          </time>
                          <h3 class="font-display text-base font-bold text-foreground mb-2 group-hover:text-accent transition-colors line-clamp-3 flex-1 min-h-[4.2rem] leading-snug">
                            {entry.data.title}
                          </h3>
                          <p class="text-sm text-muted-foreground line-clamp-3">
                            {entry.data.description}
                          </p>
                        </div>
                      </article>
                    </a>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    </section>
  </main>
</BaseLayout>
